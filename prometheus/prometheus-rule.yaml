apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: xfinity-usage-alerts
spec:
  groups:
    - name: xfinity-usage
      interval: 30s
      rules:
        # Alert when 3+ consecutive failures (warning).
        - alert: XfinityUsageMultipleFailures
          expr: xfinity_usage_consecutive_failures >= 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Xfinity usage has {{ $value }} consecutive failures"
            description: "The xfinity-usage job has failed {{ $value }} times consecutively."

        # Alert when 6+ consecutive failures (critical).
        - alert: XfinityUsageFrequentFailures
          expr: xfinity_usage_consecutive_failures >= 6
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Xfinity usage has {{ $value }} consecutive failures"
            description: "The xfinity-usage job has failed {{ $value }} times consecutively. Immediate attention required."

        # Alert when no successful runs in 2 hours (critical).
        - alert: XfinityUsageNoSuccessfulRuns
          expr: time() - xfinity_usage_last_success_timestamp > 7200 and xfinity_usage_last_run_success == 0
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: "Xfinity usage has had no successful runs in 2 hours"
            description: "The xfinity-usage job has not completed successfully in over 2 hours."

        # Alert when job hasn't run at all in 1 hour (critical - likely CronJob issue).
        - alert: XfinityUsageJobStalled
          expr: time() - xfinity_usage_last_run_timestamp > 3600
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: "Xfinity usage job appears stalled"
            description: "The xfinity-usage CronJob hasn't executed at all in the last hour. Expected runs every 20 minutes."

        # Alert on high token refresh error rate (3+ in 6 hours).
        - alert: XfinityUsageTokenRefreshIssues
          expr: changes(xfinity_usage_last_error_timestamp{category="token_refresh"}[6h]) >= 3
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Xfinity usage experiencing token refresh issues"
            description: "Token refresh has failed {{ $value }} times in the last 6 hours. Credentials may need verification."

        # Alert on high usage fetch error rate (3+ in 6 hours).
        - alert: XfinityUsageDataFetchIssues
          expr: changes(xfinity_usage_last_error_timestamp{category="usage_fetch"}[6h]) >= 3
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Xfinity usage experiencing data fetch issues"
            description: "Usage data fetch has failed {{ $value }} times in the last 6 hours. Xfinity API may be having issues."
